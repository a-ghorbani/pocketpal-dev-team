# Story: Fix Model Loading Race Condition (Phase 1)

## Metadata
- **Task ID**: TASK-20260122-1635
- **Issue**: P0 - Critical stability bug causing app crashes
- **Source**: Production incident analysis
- **Complexity**: standard
- **Native Changes**: NO
- **Created**: 2026-01-22
- **Status**: draft

## Environment
- **Worktree**: `/Users/aghorbani/codes/pocketpal-dev-team/worktrees/TASK-20260122-1635`
- **Branch**: `feature/TASK-20260122-1635`
- **Base**: `main`

---

## Progress Tracking

### Current Phase
`[ ] Planning → [ ] Approved → [ ] Implementing → [ ] Testing → [ ] Reviewing → [ ] PR Created`

### Checkpoints (Updated by Agents)

| Checkpoint | Status | Agent | Commit | Notes |
|------------|--------|-------|--------|-------|
| Worktree created | DONE | orchestrator | - | |
| Story approved | PENDING | human | - | |
| Step 1 complete | PENDING | implementer | - | Add isInitializing flag |
| Step 2 complete | PENDING | implementer | - | Add guard in initContext() |
| Tests written | PENDING | tester | - | |
| Review passed | PENDING | reviewer | - | |
| PR created | PENDING | reviewer | - | |

### Last Agent Handoff
```yaml
from_agent: orchestrator
to_agent: planner
timestamp: 2026-01-22T16:35:00Z
status: "Story created, awaiting approval"
completed:
  - Created worktree at worktrees/TASK-20260122-1635
  - Analyzed root cause - concurrent initContext() calls
  - Classified as standard complexity
next_steps:
  - Human review and approve story
  - Then route to implementer
blockers: []
context_for_next_agent: |
  This is a P0 bug fix (not native changes).
  NATIVE_CHANGES=NO - no builds required.
  
  Root cause: UI code calls initContext() without await, allowing
  concurrent initializations when users rapidly switch models.
  
  Solution: Add isInitializing flag as guard (Phase 1 only).
  Phase 2 (llama.rn upgrade) will be done separately.
```

---

## Context (For Recovery After Context Reset)

> **If you're an agent resuming work on this story:**
> 1. Read the "Progress Tracking" section above
> 2. Check `git log` in the worktree for commits
> 3. Read the "Last Agent Handoff" section
> 4. Continue from the next incomplete checkpoint

### Background

**Critical Production Issue:**
- App rating dropped from 4.3★ to 2.0★ due to SIGSEGV crashes
- Root cause: NativeRunnable.run crashes (130 occurrences)
- Trigger: Users rapidly switching between models in UI

**Root Cause Analysis:**
1. `ModelStore.initContext()` is async (lines 969-1076 in ModelStore.ts)
2. UI components call it without `await` (e.g., HeaderRight.tsx:58, ChatPalModelPickerSheet.tsx:150, 184)
3. Users tapping rapidly on different models triggers concurrent calls
4. Multiple overlapping `initContext()` executions lead to race condition
5. `releaseContext()` is called at start of `initContext()`, but a second call before first completes causes SIGSEGV

**Impact:**
- 130+ crashes tracked by Sentry
- Users cannot reliably switch models
- App essentially unusable for core functionality

### Current State

**ModelStore.ts state management:**
- File: `/Users/aghorbani/codes/pocketpal-dev-team/worktrees/TASK-20260122-1635/src/store/ModelStore.ts`
- Lines 64-116: Store class with observable flags
  - Already has similar flags: `isContextLoading`, `inferencing`, `isStreaming`
  - All use `runInAction()` for MobX state changes
- Lines 969-1076: `initContext()` method (async)
  - Starts with `await this.releaseContext()` (line 970)
  - Sets `isContextLoading = true` in `proceedWithInitialization()` (line 1093)
  - No guard against concurrent calls

**UI components calling without await:**
- `src/components/ChatPalModelPickerSheet/ChatPalModelPickerSheet.tsx:150, 184`
- `src/components/HeaderRight/HeaderRight.tsx:58`
- `src/components/ChatView/ChatView.tsx:270`
- `src/screens/ChatScreen/VideoPalScreen.tsx:86, 91, 97, 103`
- `src/components/ProjectionModelSelector/ProjectionModelSelector.tsx:97`
- `src/screens/ModelsScreen/ModelsScreen.tsx:133`
- `src/screens/PalsScreen/components/SquarePalCard/SquarePalCard.tsx:339`

### Target State

**ModelStore.ts with race condition protection:**
- Add `isInitializing: boolean = false` flag (near line 107)
- Add guard at start of `initContext()` (line 970):
  ```typescript
  if (this.isInitializing) {
    console.warn('Model init already in progress');
    return null;
  }
  runInAction(() => { this.isInitializing = true; });
  ```
- Use `finally` block to ensure flag is cleared:
  ```typescript
  finally {
    runInAction(() => { this.isInitializing = false; });
  }
  ```

**Expected behavior:**
- First call to `initContext()` proceeds normally
- Subsequent concurrent calls return early with warning
- Flag is always cleared (even on error) via `finally`
- NativeRunnable.run crashes drop from 130 → <20

---

## Requirements

### Functional
1. [MUST] Add `isInitializing` boolean flag to ModelStore state
2. [MUST] Add guard check at start of `initContext()` to prevent concurrent calls
3. [MUST] Set `isInitializing = true` before async work starts
4. [MUST] Clear `isInitializing = false` in finally block to ensure cleanup
5. [MUST] Use `runInAction()` for all flag state changes (MobX pattern)
6. [MUST] Log warning when concurrent init is prevented
7. [MUST] Return `null` from guarded calls (existing callers already handle null)

### Non-Functional
- Performance: Guard check adds <1ms overhead (simple boolean check)
- Compatibility: No breaking changes - existing null handling preserved
- Stability: Prevents 130+ crashes per week

---

## Acceptance Criteria

- [ ] `isInitializing` flag added to ModelStore (near line 107)
- [ ] Guard check added at start of `initContext()` (line 970)
- [ ] Flag set to `true` before async work, cleared in `finally`
- [ ] All flag changes use `runInAction()`
- [ ] Warning logged when concurrent init prevented
- [ ] Unit tests pass for rapid model switching scenario
- [ ] All tests pass
- [ ] Coverage >= 60%
- [ ] TypeScript compiles without errors

---

## Affected Files

| File | Action | Reason | Status |
|------|--------|--------|--------|
| `src/store/ModelStore.ts` | MODIFY | Add isInitializing flag and guard logic | PENDING |
| `src/store/__tests__/ModelStore.test.ts` | MODIFY | Add test for race condition prevention | PENDING |
| `__mocks__/stores/modelStore.ts` | MODIFY | Add isInitializing flag to mock | PENDING |

---

## Implementation Plan

### Step 1: Add isInitializing Flag to ModelStore
**Files**: `src/store/ModelStore.ts`
**Status**: `PENDING`
**Commit**: [commit hash when done]

**Change**:
- [ ] Add `isInitializing: boolean = false;` near line 107 (with other boolean flags)
- [ ] Follow existing pattern: `isContextLoading`, `inferencing`, `isStreaming`

**Pattern Reference**: See `src/store/ModelStore.ts:77-108` for existing flag declarations

**Code Guidance**:
```typescript
// Around line 107-108, add:
inferencing: boolean = false;
isStreaming: boolean = false;
isInitializing: boolean = false;  // NEW: Prevent concurrent model initialization
```

**Verification**:
```bash
cd /Users/aghorbani/codes/pocketpal-dev-team/worktrees/TASK-20260122-1635
yarn typecheck
```

### Step 2: Add Guard Logic to initContext()
**Files**: `src/store/ModelStore.ts`
**Status**: `PENDING`
**Commit**: [commit hash when done]

**Change**:
- [ ] Add guard check at start of `initContext()` (line 969)
- [ ] Set `isInitializing = true` using `runInAction()` after guard
- [ ] Wrap entire method body in try-finally
- [ ] Clear `isInitializing = false` in finally block using `runInAction()`

**Pattern Reference**: 
- See `src/store/ModelStore.ts:1092-1097` for `runInAction()` usage
- See `src/store/ModelStore.ts:1104-1178` for try-catch pattern

**Code Guidance**:
```typescript
// Line 969: Replace method signature with guard
initContext = async (model: Model, mmProjPath?: string) => {
  // Guard: Prevent concurrent initialization
  if (this.isInitializing) {
    console.warn('[ModelStore] Model initialization already in progress, ignoring concurrent call');
    return null;
  }
  
  // Set flag before any async work
  runInAction(() => {
    this.isInitializing = true;
  });
  
  try {
    // Existing code: await this.releaseContext() and rest of method
    await this.releaseContext();
    const filePath = await this.getModelFullPath(model);
    // ... rest of existing implementation (lines 971-1076)
    
  } finally {
    // Always clear flag, even on error
    runInAction(() => {
      this.isInitializing = false;
    });
  }
};
```

**Important Notes:**
- Place guard check BEFORE any async operations (including `releaseContext()`)
- Use `runInAction()` for all state changes (MobX requirement)
- `finally` block ensures flag is always cleared (even if error thrown)
- Return `null` matches existing pattern (callers already handle this)

**Verification**:
```bash
cd /Users/aghorbani/codes/pocketpal-dev-team/worktrees/TASK-20260122-1635
yarn lint
yarn typecheck
yarn test src/store/__tests__/ModelStore.test.ts
```

### Step 3: Update Mock Store
**Files**: `__mocks__/stores/modelStore.ts`
**Status**: `PENDING`
**Commit**: [commit hash when done]

**Change**:
- [ ] Add `isInitializing: boolean = false;` to MockModelStore class (after line 52)

**Pattern Reference**: See `__mocks__/stores/modelStore.ts:18-52` for existing flag declarations

**Code Guidance**:
```typescript
// Around line 52, add:
isContextLoading: boolean = false;
loadingModel: Model | undefined;
isInitializing: boolean = false;  // NEW: Match real store
```

**Verification**:
```bash
cd /Users/aghorbani/codes/pocketpal-dev-team/worktrees/TASK-20260122-1635
yarn test
```

---

## Test Requirements

### Unit Tests
| Test Case | File | Priority | Status |
|-----------|------|----------|--------|
| Prevents concurrent initContext() calls | `ModelStore.test.ts` | MUST | PENDING |
| Sets isInitializing=true during init | `ModelStore.test.ts` | MUST | PENDING |
| Clears isInitializing=false after success | `ModelStore.test.ts` | MUST | PENDING |
| Clears isInitializing=false after error | `ModelStore.test.ts` | MUST | PENDING |
| Returns null when guard triggered | `ModelStore.test.ts` | MUST | PENDING |
| Logs warning when concurrent call prevented | `ModelStore.test.ts` | SHOULD | PENDING |

### Test Implementation Guidance

**Test Case 1: Prevents concurrent initContext() calls**
```typescript
it('should prevent concurrent initContext calls', async () => {
  const model = basicModel;
  
  // Mock initLlama to introduce delay
  const mockContext = {release: jest.fn()} as unknown as LlamaContext;
  const initLlamaMock = require('llama.rn').initLlama;
  initLlamaMock.mockImplementation(() => 
    new Promise(resolve => setTimeout(() => resolve(mockContext), 100))
  );
  
  // Start first init (doesn't await)
  const firstCall = modelStore.initContext(model);
  
  // Immediately try second init (should be prevented)
  const secondCall = await modelStore.initContext(model);
  
  // Second call should return null (guarded)
  expect(secondCall).toBeNull();
  
  // Wait for first to complete
  await firstCall;
  
  // initLlama should only be called once
  expect(initLlamaMock).toHaveBeenCalledTimes(1);
});
```

**Test Case 2: Sets isInitializing=true during init**
```typescript
it('should set isInitializing during initialization', async () => {
  const model = basicModel;
  const mockContext = {release: jest.fn()} as unknown as LlamaContext;
  const initLlamaMock = require('llama.rn').initLlama;
  
  let flagValueDuringInit: boolean = false;
  initLlamaMock.mockImplementation(async () => {
    // Capture flag value while init is running
    flagValueDuringInit = modelStore.isInitializing;
    return mockContext;
  });
  
  await modelStore.initContext(model);
  
  expect(flagValueDuringInit).toBe(true);
});
```

**Test Case 3: Clears isInitializing=false after success**
```typescript
it('should clear isInitializing after successful init', async () => {
  const model = basicModel;
  const mockContext = {release: jest.fn()} as unknown as LlamaContext;
  const initLlamaMock = require('llama.rn').initLlama;
  initLlamaMock.mockResolvedValue(mockContext);
  
  await modelStore.initContext(model);
  
  expect(modelStore.isInitializing).toBe(false);
});
```

**Test Case 4: Clears isInitializing=false after error**
```typescript
it('should clear isInitializing even when init fails', async () => {
  const model = basicModel;
  const initLlamaMock = require('llama.rn').initLlama;
  initLlamaMock.mockRejectedValue(new Error('Init failed'));
  
  try {
    await modelStore.initContext(model);
  } catch (error) {
    // Expected to throw
  }
  
  // Flag should still be cleared
  expect(modelStore.isInitializing).toBe(false);
});
```

**Test Case 5: Returns null when guard triggered**
```typescript
it('should return null when concurrent call is prevented', async () => {
  const model = basicModel;
  
  // Manually set flag to simulate in-progress init
  runInAction(() => {
    modelStore.isInitializing = true;
  });
  
  const result = await modelStore.initContext(model);
  
  expect(result).toBeNull();
  
  // Clean up
  runInAction(() => {
    modelStore.isInitializing = false;
  });
});
```

**Test Case 6: Logs warning when concurrent call prevented**
```typescript
it('should log warning when concurrent init is prevented', async () => {
  const model = basicModel;
  const consoleWarnSpy = jest.spyOn(console, 'warn').mockImplementation();
  
  // Manually set flag
  runInAction(() => {
    modelStore.isInitializing = true;
  });
  
  await modelStore.initContext(model);
  
  expect(consoleWarnSpy).toHaveBeenCalledWith(
    expect.stringContaining('already in progress')
  );
  
  consoleWarnSpy.mockRestore();
  runInAction(() => {
    modelStore.isInitializing = false;
  });
});
```

### Manual Testing
- [ ] Open app and navigate to model picker
- [ ] Rapidly tap different models (5+ taps in <2 seconds)
- [ ] Verify no crashes occur
- [ ] Verify only one model loads successfully
- [ ] Check logs for "already in progress" warnings
- [ ] Test on both iOS and Android

---

## Coding Standards

### Testing Infrastructure (CRITICAL)
```
# Read these BEFORE writing tests:
/Users/aghorbani/codes/pocketpal-dev-team/worktrees/TASK-20260122-1635/jest/setup.ts      # Global mocks
/Users/aghorbani/codes/pocketpal-dev-team/worktrees/TASK-20260122-1635/jest/test-utils.tsx # Custom render
/Users/aghorbani/codes/pocketpal-dev-team/worktrees/TASK-20260122-1635/__mocks__/stores/  # Mock stores

# DO NOT mock stores inline - they're globally mocked
# Use runInAction() for MobX state changes
# Import render from jest/test-utils, NOT @testing-library/react-native
```

### Patterns to Follow
- **State**: Use MobX `runInAction()` for all observable changes
- **Async Actions**: Use try-finally for cleanup (never rely on catch alone)
- **Logging**: Use descriptive warnings for guarded conditions
- **Types**: Return types must match existing pattern (`LlamaContext | null`)

### Commit Format (enforced by commitlint)
```
fix(model): prevent concurrent initialization race condition
```

**Rules**:
- Type: `fix` (bug fix)
- Scope: `model` (ModelStore)
- Keep under 100 chars total

### Naming Conventions
- Boolean flags: `isXxxx` pattern (e.g., `isInitializing`)
- Console messages: Include store name prefix `[ModelStore]`

---

## Reference Code

### Pattern Example: MobX runInAction Usage
**File**: `src/store/ModelStore.ts`
**Lines**: 1092-1097
```typescript
runInAction(() => {
  this.isContextLoading = true;
  this.loadingModel = model;
  this.isMultimodalActive = false; // Reset until we confirm it's enabled
  this.activeProjectionModelId = projectionModel?.id;
});
```

### Pattern Example: Try-Finally Cleanup
**File**: `src/store/ModelStore.ts`
**Lines**: 1104-1178
```typescript
try {
  // Create properly versioned ContextInitParams
  const contextInitParams = createContextInitParams(effectiveSettings);
  const t0 = Date.now();
  const ctx = await initLlama(contextInitParams);
  // ... more code
} catch (e) {
  // ... error handling
  throw e;
} finally {
  runInAction(() => {
    this.isContextLoading = false;
    this.loadingModel = undefined;
  });
}
```

### Pattern Example: Existing Boolean Flags
**File**: `src/store/ModelStore.ts`
**Lines**: 77-108
```typescript
isContextLoading: boolean = false;
loadingModel: Model | undefined = undefined;

// Unified context initialization parameters
contextInitParams: ContextInitParams = createDefaultContextInitParams();

max_threads: number = 4; // Will be set in constructor

activeModelId: string | undefined = undefined;

// Flag to track if multimodal is currently active
isMultimodalActive: boolean = false;
activeProjectionModelId: string | undefined = undefined;

// Track initialization settings for the active context
activeContextSettings: ContextInitParams | undefined = undefined;

context: LlamaContext | undefined = undefined;

lastUsedModelId: string | undefined = undefined;

// Auto-release tracking (persistent)
wasAutoReleased: boolean = false;
lastAutoReleasedModelId: string | undefined = undefined;

// System UI protection (runtime)
private autoReleaseDisabledReasons = new Set<string>();

MIN_CONTEXT_SIZE = 200;

inferencing: boolean = false;
isStreaming: boolean = false;
```

---

## Dependencies

### Blocked By
- None

### Blocks
- Phase 2: llama.rn upgrade (will be done separately)

---

## Risks & Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Flag not cleared on error path | Low | High | Use `finally` block to guarantee cleanup |
| Guard prevents legitimate re-init after error | Low | Medium | Flag cleared in `finally`, always safe to retry |
| UI shows stale loading state | Low | Low | Existing `isContextLoading` flag handles UI state |
| Performance regression | Very Low | Low | Boolean check adds <1ms overhead |

---

## Open Questions

### For Human
- None - implementation approach approved in decision log

### Resolved
- Q: Should we await initContext in UI code?
  - A: No. Phase 1 uses guard flag. UI code changes not needed (they already handle null).
- Q: What about llama.rn upgrade?
  - A: Phase 2 (separate task). Phase 1 ships TODAY for stability.

---

## Agent Reports

### Planner Report
```
Research completed: 2026-01-22T16:35:00Z

Root cause confirmed:
- 10+ UI components call initContext() without await
- Rapid user taps trigger concurrent calls
- releaseContext() at start of initContext() creates race condition
- SIGSEGV when context freed mid-initialization

Implementation approach validated:
- Add isInitializing boolean flag (follows existing pattern)
- Guard check at method start (simple, safe)
- runInAction() for all state changes (MobX requirement)
- finally block for guaranteed cleanup

Affected files identified:
1. ModelStore.ts - Add flag + guard logic
2. ModelStore.test.ts - Add race condition tests
3. modelStore.ts (mock) - Add flag to mock

Pattern compliance verified:
- Store already uses similar flags (isContextLoading, inferencing, isStreaming)
- All use runInAction() pattern
- Try-finally cleanup pattern exists in proceedWithInitialization()

Test strategy defined:
- 6 test cases covering concurrent calls, flag lifecycle, error handling
- Manual testing for rapid model switching
- No native builds required (NATIVE_CHANGES=NO)

Ready for human approval.
```

---

## Changelog

| Date | Agent/Human | Change |
|------|-------------|--------|
| 2026-01-22 | orchestrator | Created worktree and task |
| 2026-01-22 | planner | Initial story draft with comprehensive test plan |
