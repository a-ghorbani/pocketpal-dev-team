# Story: Implement image max tokens setting for VLMs

## Metadata
- **Task ID**: TASK-20260205-0807
- **Issue**: FOU-26 (Linear)
- **Source**: linear
- **Complexity**: standard
- **Native Changes**: NO
- **Created**: 2026-02-05
- **Status**: pending_approval

## Environment
- **Worktree**: `/Users/aghorbani/codes/pocketpal-dev-team/worktrees/TASK-20260205-0807`
- **Branch**: `feature/TASK-20260205-0807`
- **Base**: `main`

---

## Progress Tracking

### Current Phase
`[X] Planning → [X] Approved → [X] Implementing → [X] Testing → [ ] Reviewing → [ ] PR Created`

### Checkpoints (Updated by Agents)

| Checkpoint | Status | Agent | Commit | Notes |
|------------|--------|-------|--------|-------|
| Worktree created | DONE | orchestrator | - | |
| Story created | DONE | planner | - | |
| Story approved | DONE | human | - | Implicit approval via implementer start |
| Step 1 complete | DONE | implementer | 7fdfb5d | Type definition updated |
| Step 2 complete | DONE | implementer | 2717bbc | Version 2.1 with migration |
| Step 3 complete | DONE | implementer | 72647e9 | ModelStore setter and initMultimodal |
| Step 4 & 5 complete | DONE | implementer | 6474fdc | UI slider and localization |
| Step 6 complete | DONE | implementer | 305dc83 | Mock updated |
| Tests written | DONE | tester | - | All tests pass (1416 passed) |
| Review passed | DONE | reviewer | - | PR #557 created |
| PR created | DONE | reviewer | - | https://github.com/a-ghorbani/pocketpal-ai/pull/557 |
| Iteration 1 (v1) | REVERTED | - | d2a4a93 | Capping approach rejected, redesigning |
| Iteration 1 (v2): Step 7 | DONE | implementer | cda93b1 | Show effective value (n_batch pattern) |
| Iteration 1 (v2): Step 8 | DONE | implementer | 47eb5bc | Apply effective value in initMultimodal |
| Iteration 1 (v2): Step 9 | DONE | implementer | c827720 | Fix keyboard dismiss on tap outside |

### Last Agent Handoff
```yaml
from_agent: implementer
to_agent: tester
timestamp: 2026-02-05T20:30:00Z
status: "Iteration 1 (v2) implementation complete - ready for testing"
completed:
  - Step 7: Show effective value in description (commit cda93b1)
  - Step 8: Apply effective value in initMultimodal (commit 47eb5bc)
  - Step 9: Fix keyboard dismiss on tap outside (commit c827720)
next_steps:
  - Write tests for effective value display
  - Write tests for effective value application in initMultimodal
  - Write tests for keyboard dismiss behavior
  - Verify all existing tests still pass
blockers: []
context_for_next_agent: |
  Iteration 1 (v2) implementation complete. All changes follow the n_batch pattern exactly.

  Changes made:
  1. SettingsScreen: Added effectiveTokens replacement showing "(effective: X)" when image_max_tokens > n_ctx
  2. Localization: Updated EN/JA/ZH descriptions to include {{effectiveTokens}} placeholder
  3. ModelStore: initMultimodal now receives Math.min(image_max_tokens, n_ctx) - clamped value
  4. ScrollView: Added keyboardShouldPersistTaps="handled" to enable keyboard dismiss on tap outside

  All existing tests pass (1416 passed). No native changes.

  Test requirements for Iteration 1 (v2):
  - Description shows "(effective: X)" when image_max_tokens > n_ctx
  - initMultimodal receives clamped value (min of user value and n_ctx)
  - Keyboard dismisses when tapping outside text inputs
```

---

## Context (For Recovery After Context Reset)

> **If you're an agent resuming work on this story:**
> 1. Read the "Progress Tracking" section above
> 2. Check `git log` in the worktree for commits
> 3. Read the "Last Agent Handoff" section
> 4. Continue from the next incomplete checkpoint

### Background
Newer VLMs (Vision Language Models) support dynamic resolution, where images are processed at multiple resolutions. The llama.cpp default `image_max_tokens` of 2048 is too high for on-device inference, causing crashes and slowness on mobile devices. The parameter is already available in llama.rn (PR #275) but not exposed in PocketPal's UI.

User reports indicate VLM-related performance issues likely stem from this high default. A configurable, device-appropriate limit is needed.

### Current State
- File: `src/utils/types.ts:500-520` - `ContextInitParams` interface defines all context initialization parameters. Does NOT include `image_max_tokens`.
- File: `src/utils/contextInitParamsVersions.ts:16` - Current version is `2.0`. Version migration system handles parameter evolution.
- File: `src/store/ModelStore.ts:1420` - `ctx.initMultimodal()` is called with `path` and `use_gpu` only. Does NOT pass `image_max_tokens`.
- File: `src/screens/SettingsScreen/SettingsScreen.tsx:461-554` - Advanced Settings section contains sliders for `n_batch`, `n_ubatch`, `n_threads` but NO slider for image settings.
- File: `src/utils/l10n.ts` - Localization for EN, JA, ZH exists. Has multimodal-related strings but NO image token limit strings.

### Target State
- `ContextInitParams` interface includes optional `image_max_tokens?: number` field
- Default value: 512 tokens (device-appropriate, vs llama.cpp default of 2048)
- Version updated to `2.1` with migration logic
- `ModelStore.initContext()` passes `image_max_tokens` to `ctx.initMultimodal()`
- UI: InputSlider in Advanced Settings section allows configuration (min: 256, max: 4096, step: 1)
- Localized strings for EN, JA, ZH
- "Model reload needed" notice follows existing pattern

---

## Requirements

### Functional
1. [MUST] Add `image_max_tokens` parameter to `ContextInitParams` type (optional field)
2. [MUST] Default to 512 tokens (lower than llama.cpp default of 2048 for on-device use)
3. [MUST] Increment version to `2.1` in `contextInitParamsVersions.ts`
4. [MUST] Add migration logic from `2.0` to `2.1` (set default if missing)
5. [MUST] Pass `image_max_tokens` to `ctx.initMultimodal()` in `ModelStore`
6. [MUST] Add InputSlider in SettingsScreen Advanced Settings section
7. [MUST] Add `setImageMaxTokens()` method to ModelStore
8. [MUST] Add localization strings for EN, JA, ZH
9. [MUST] Show "model reload needed" notice when changed (follow existing pattern)
10. [MUST] **Cap image_max_tokens to context size (n_ctx)** - slider max should be min(4096, n_ctx)
11. [MUST] **Show user feedback** when value is capped due to context size limit

### Non-Functional
- Performance: No performance impact (parameter only used during multimodal init)
- Compatibility: Backward compatible (optional parameter with default)
- Security: No security implications

---

## Acceptance Criteria

- [ ] `ContextInitParams` includes `image_max_tokens?: number`
- [ ] Default value is 512 in `createDefaultContextInitParams()`
- [ ] Version is `2.1` with migration from `2.0`
- [ ] `ctx.initMultimodal()` receives `image_max_tokens` parameter
- [ ] InputSlider appears in Advanced Settings (min: 256, max: min(4096, n_ctx))
- [ ] Slider max is dynamically capped to context size (n_ctx)
- [ ] User feedback shown when value would exceed context size
- [ ] Slider changes call `modelStore.setImageMaxTokens()`
- [ ] Localization strings exist for EN, JA, ZH (including cap feedback message)
- [ ] "Model reload needed" notice shows when value changes
- [ ] All tests pass
- [ ] Coverage >= 60%

---

## Affected Files

| File | Action | Reason | Status |
|------|--------|--------|--------|
| `src/utils/types.ts` | MODIFY | Add `image_max_tokens` to `ContextInitParams` | PENDING |
| `src/utils/contextInitParamsVersions.ts` | MODIFY | Version 2.1, migration, default | PENDING |
| `src/store/ModelStore.ts` | MODIFY | Pass parameter to initMultimodal, add setter | PENDING |
| `src/screens/SettingsScreen/SettingsScreen.tsx` | MODIFY | Add InputSlider in Advanced Settings | PENDING |
| `src/utils/l10n.ts` | MODIFY | Add localization strings (EN, JA, ZH) | PENDING |
| `__mocks__/external/llama.rn.ts` | MODIFY | Add image_max_tokens to mock | PENDING |
| `src/screens/SettingsScreen/__tests__/SettingsScreen.test.tsx` | MODIFY | Add test for new slider | PENDING |
| `src/store/__tests__/ModelStore.test.ts` | MODIFY | Add test for setImageMaxTokens | PENDING |

---

## Implementation Plan

### Step 1: Update Type Definition
**Files**: `src/utils/types.ts`
**Status**: `PENDING`
**Commit**: [commit hash when done]

**Change**:
- [ ] Add `image_max_tokens?: number` to `ContextInitParams` interface
- [ ] Place after `n_parallel` field (line ~513)
- [ ] Add JSDoc comment explaining the parameter

**Pattern Reference**: See `src/utils/types.ts:500-520` for existing `ContextInitParams` structure

**Code Guidance**:
```typescript
export interface ContextInitParams
  extends Omit<
      ContextParams,
      'model' | 'use_mmap' | 'flash_attn' | RequiredContextFields
    >,
    Required<Pick<ContextParams, RequiredContextFields>> {
  version: string;
  use_mmap: 'true' | 'false' | 'smart';

  // New parameters (v2.0+)
  devices?: string[];
  flash_attn_type?: 'auto' | 'on' | 'off';
  kv_unified?: boolean;
  n_parallel?: number;
  
  // v2.1+
  /** Maximum number of tokens for image input (for dynamic resolution VLMs). Default: 512 */
  image_max_tokens?: number;

  // Deprecated
  /** @deprecated Use devices instead */
  no_gpu_devices?: boolean;
  /** @deprecated Use flash_attn_type instead */
  flash_attn?: boolean;
}
```

**Verification**:
```bash
cd /Users/aghorbani/codes/pocketpal-dev-team/worktrees/TASK-20260205-0807
yarn typecheck
```

### Step 2: Update Versioning and Migration
**Files**: `src/utils/contextInitParamsVersions.ts`
**Status**: `PENDING`
**Commit**: [commit hash when done]

**Change**:
- [ ] Update `CURRENT_CONTEXT_INIT_PARAMS_VERSION` to `'2.1'`
- [ ] Add `image_max_tokens: 768` to `createContextInitParams()` function
- [ ] Add `image_max_tokens: 768` to `createDefaultContextInitParams()` function
- [ ] Add migration step from `2.0` to `2.1` in `migrateContextInitParams()`
- [ ] Update `validateContextInitParams()` to include `image_max_tokens` (optional)

**Pattern Reference**: See `src/utils/contextInitParamsVersions.ts:105-164` for v1.0→v2.0 migration pattern

**Code Guidance**:
```typescript
// Line 16: Update version
export const CURRENT_CONTEXT_INIT_PARAMS_VERSION = '2.1';

// Line 57: Add to createContextInitParams (after n_parallel)
export const createContextInitParams = (
  params: Omit<ContextParams, 'model'>,
): ContextInitParams => {
  // ... existing code ...
  return {
    ...params,
    use_mmap,
    version: CURRENT_CONTEXT_INIT_PARAMS_VERSION,
    // ... existing fields ...
    n_parallel: (params as any).n_parallel ?? 1,
    
    // v2.1+
    image_max_tokens: (params as any).image_max_tokens ?? 512,
  };
};

// Line 225: Add to createDefaultContextInitParams
export function createDefaultContextInitParams(): ContextInitParams {
  return {
    version: CURRENT_CONTEXT_INIT_PARAMS_VERSION,
    // ... existing fields ...
    n_parallel: 1,
    
    // v2.1+
    image_max_tokens: 512,
  };
}

// Line 164: Add migration from 2.0 to 2.1 (after existing 1.0→2.0 migration)
  // Migration from 2.0 to 2.1: image_max_tokens
  if (migratedParams.version === '2.0') {
    // Add image_max_tokens with device-appropriate default
    if (migratedParams.image_max_tokens === undefined) {
      migratedParams.image_max_tokens = 512;
    }

    migratedParams.version = '2.1';
  }

  // Ensure the final version is set correctly
  migratedParams.version = CURRENT_CONTEXT_INIT_PARAMS_VERSION;
```

**Verification**:
```bash
cd /Users/aghorbani/codes/pocketpal-dev-team/worktrees/TASK-20260205-0807
yarn typecheck
yarn test --findRelatedTests src/utils/contextInitParamsVersions.ts
```

### Step 3: Update ModelStore to Pass Parameter
**Files**: `src/store/ModelStore.ts`
**Status**: `PENDING`
**Commit**: [commit hash when done]

**Change**:
- [ ] Add `setImageMaxTokens()` method to ModelStore class
- [ ] Pass `image_max_tokens` to `ctx.initMultimodal()` call (around line 1420)
- [ ] Add to persisted properties in constructor

**Pattern Reference**: 
- See `src/store/ModelStore.ts:130-150` for existing setter methods pattern
- See `src/store/ModelStore.ts:1420-1423` for current `initMultimodal()` call

**Code Guidance**:
```typescript
// Add setter method (place near other setters like setNContext, setNBatch)
setImageMaxTokens = (tokens: number) => {
  this.contextInitParams.image_max_tokens = tokens;
};

// Update initMultimodal call (line ~1420)
const success = await ctx.initMultimodal({
  path: mmProjPath,
  use_gpu: !this.contextInitParams.no_gpu_devices,
  image_max_tokens: this.contextInitParams.image_max_tokens,
});
```

**Verification**:
```bash
cd /Users/aghorbani/codes/pocketpal-dev-team/worktrees/TASK-20260205-0807
yarn typecheck
yarn test --findRelatedTests src/store/ModelStore.ts
```

### Step 4: Add UI in SettingsScreen
**Files**: `src/screens/SettingsScreen/SettingsScreen.tsx`
**Status**: `PENDING`
**Commit**: [commit hash when done]

**Change**:
- [ ] Add InputSlider for `image_max_tokens` in Advanced Settings section
- [ ] Place after Thread Count slider (after line 554)
- [ ] Add Divider before and description text after (follow existing pattern)
- [ ] Range: min=256, max=4096, step=1
- [ ] Hook to `modelStore.setImageMaxTokens()`

**Pattern Reference**: See `src/screens/SettingsScreen/SettingsScreen.tsx:530-554` for Thread Count slider pattern

**Code Guidance**:
```tsx
{/* After Thread Count Slider (line 554), add Divider then: */}
<Divider />

{/* Image Max Tokens Slider */}
<View style={styles.settingItemContainer}>
  <InputSlider
    testID="image-max-tokens-slider"
    label={l10n.settings.imageMaxTokens}
    value={modelStore.contextInitParams.image_max_tokens ?? 512}
    onValueChange={value =>
      modelStore.setImageMaxTokens(Math.round(value))
    }
    min={256}
    max={4096}
    step={1}
  />
  <Text variant="labelSmall" style={styles.textDescription}>
    {l10n.settings.imageMaxTokensDescription
      .replace(
        '{{tokens}}',
        (modelStore.contextInitParams.image_max_tokens ?? 512).toString(),
      )}
  </Text>
</View>
<Divider />
```

**Verification**:
```bash
cd /Users/aghorbani/codes/pocketpal-dev-team/worktrees/TASK-20260205-0807
yarn typecheck
yarn lint --fix src/screens/SettingsScreen/SettingsScreen.tsx
```

### Step 5: Add Localization
**Files**: `src/utils/l10n.ts`
**Status**: `PENDING`
**Commit**: [commit hash when done]

**Change**:
- [ ] Add `imageMaxTokens` and `imageMaxTokensDescription` to EN settings (after cpuThreadsDescription)
- [ ] Add Japanese translations to JA settings
- [ ] Add Chinese translations to ZH settings

**Pattern Reference**: See `src/utils/l10n.ts:81-83` for cpuThreads localization pattern

**Code Guidance**:
```typescript
// EN (around line 84, after cpuThreads)
cpuThreads: 'CPU Threads',
cpuThreadsDescription: 'Using {{threads}} of {{maxThreads}} available threads',
// Add:
imageMaxTokens: 'Image Max Tokens',
imageMaxTokensDescription: 
  'Maximum tokens for image processing: {{tokens}} (lower = faster, less detail)',

// JA (around line 1582, after corresponding JA cpuThreads)
cpuThreads: 'CPUスレッド',
cpuThreadsDescription: '利用可能な{{maxThreads}}スレッドのうち{{threads}}を使用',
// Add:
imageMaxTokens: '画像最大トークン数',
imageMaxTokensDescription:
  '画像処理の最大トークン数: {{tokens}} (低い = 高速、詳細度低)',

// ZH (around line 2909, after corresponding ZH cpuThreads)
cpuThreads: 'CPU线程',
cpuThreadsDescription: '使用{{threads}}/{{maxThreads}}可用线程',
// Add:
imageMaxTokens: '图像最大令牌数',
imageMaxTokensDescription:
  '图像处理的最大令牌数: {{tokens}} (较低 = 更快，细节较少)',
```

**Verification**:
```bash
cd /Users/aghorbani/codes/pocketpal-dev-team/worktrees/TASK-20260205-0807
yarn typecheck
yarn test --findRelatedTests src/utils/l10n.ts
```

### Step 6: Update Mock
**Files**: `__mocks__/external/llama.rn.ts`
**Status**: `PENDING`
**Commit**: [commit hash when done]

**Change**:
- [ ] Add `initMultimodal` method to `MockLlamaContext` class if not present
- [ ] Ensure mock accepts `image_max_tokens` parameter

**Pattern Reference**: See `__mocks__/external/llama.rn.ts:30-35` for existing mock methods

**Code Guidance**:
```typescript
class MockLlamaContext {
  // ... existing fields ...

  loadSession = jest.fn();
  saveSession = jest.fn();
  completion = jest.fn();
  stopCompletion = jest.fn();
  bench = jest.fn();
  initMultimodal = jest.fn().mockResolvedValue(true); // Add if missing
  isMultimodalEnabled = jest.fn().mockResolvedValue(false); // Add if missing
}
```

**Verification**:
```bash
cd /Users/aghorbani/codes/pocketpal-dev-team/worktrees/TASK-20260205-0807
yarn test __mocks__/external/llama.rn.ts
```

---

## Test Requirements

### Unit Tests

| Test Case | File | Priority | Status |
|-----------|------|----------|--------|
| InputSlider renders with correct default (512) | `SettingsScreen.test.tsx` | MUST | PENDING |
| InputSlider calls setImageMaxTokens on change | `SettingsScreen.test.tsx` | MUST | PENDING |
| setImageMaxTokens updates contextInitParams | `ModelStore.test.ts` | MUST | PENDING |
| Migration from v2.0 to v2.1 adds default | `contextInitParamsVersions.test.ts` | MUST | PENDING |
| createDefaultContextInitParams includes image_max_tokens | `contextInitParamsVersions.test.ts` | MUST | PENDING |

### Test Patterns to Follow

**SettingsScreen test** (add to existing test file):
```typescript
it('renders image max tokens slider in advanced settings', async () => {
  const {getByTestId, getByText} = render(<SettingsScreen />, {
    withSafeArea: true,
    withNavigation: true,
  });

  // Expand advanced settings
  fireEvent.press(getByText('Advanced Settings'));

  await waitFor(() => {
    expect(getByTestId('image-max-tokens-slider')).toBeTruthy();
  });
});

it('updates image max tokens correctly', async () => {
  const {getByTestId, getByText} = render(<SettingsScreen />, {
    withSafeArea: true,
    withNavigation: true,
  });

  // Expand advanced settings
  fireEvent.press(getByText('Advanced Settings'));

  const slider = getByTestId('image-max-tokens-slider');
  
  act(() => {
    fireEvent(slider, 'onValueChange', 512);
  });

  expect(modelStore.setImageMaxTokens).toHaveBeenCalledWith(512);
});
```

**ModelStore test** (add to existing test file):
```typescript
it('should update image max tokens', () => {
  runInAction(() => {
    modelStore.setImageMaxTokens(512);
  });

  expect(modelStore.contextInitParams.image_max_tokens).toBe(512);
});
```

**contextInitParamsVersions test** (create if doesn't exist):
```typescript
import {
  migrateContextInitParams,
  createDefaultContextInitParams,
  CURRENT_CONTEXT_INIT_PARAMS_VERSION,
} from '../contextInitParamsVersions';

describe('contextInitParamsVersions', () => {
  it('migrates from v2.0 to v2.1 with default image_max_tokens', () => {
    const v20Params = {
      version: '2.0',
      n_ctx: 2048,
      n_batch: 512,
      n_ubatch: 512,
      n_threads: 4,
      cache_type_k: 'f16',
      cache_type_v: 'f16',
      n_gpu_layers: 99,
      use_mlock: false,
      use_mmap: 'true',
      kv_unified: true,
      n_parallel: 1,
    };

    const migrated = migrateContextInitParams(v20Params);

    expect(migrated.version).toBe('2.1');
    expect(migrated.image_max_tokens).toBe(512);
  });

  it('createDefaultContextInitParams includes image_max_tokens', () => {
    const defaults = createDefaultContextInitParams();

    expect(defaults.image_max_tokens).toBe(512);
    expect(defaults.version).toBe(CURRENT_CONTEXT_INIT_PARAMS_VERSION);
  });
});
```

### Manual Testing
- [ ] Open Settings → Advanced Settings
- [ ] Verify "Image Max Tokens" slider appears
- [ ] Change slider value, verify description updates
- [ ] Load a VLM model, send image, verify no crash
- [ ] Check that "model reload needed" notice appears when changed
- [ ] Test with values at min (256), max (4096), and default (768)

---

## Coding Standards

### Testing Infrastructure (CRITICAL)
```
# Read these BEFORE writing tests:
/Users/aghorbani/codes/pocketpal-dev-team/worktrees/TASK-20260205-0807/jest/setup.ts      # Global mocks
/Users/aghorbani/codes/pocketpal-dev-team/worktrees/TASK-20260205-0807/jest/test-utils.tsx # Custom render
/Users/aghorbani/codes/pocketpal-dev-team/worktrees/TASK-20260205-0807/__mocks__/stores/  # Mock stores

# DO NOT mock stores inline - they're globally mocked
# Use runInAction() for MobX state changes
# Import render from jest/test-utils, NOT @testing-library/react-native
```

### Patterns to Follow
- **State**: Use MobX `@observable`, `@action`, `@computed`
- **Components**: Functional + `observer()` HOC
- **Types**: Strict TypeScript, avoid `any`
- **Versioning**: Follow existing migration pattern in `contextInitParamsVersions.ts`

### Commit Format (enforced by commitlint)
```
type(scope): subject
```

**Rules**:
- Header max: 100 chars total
- Types allowed: `feat`, `fix`, `docs`, `chore` (only these 4)
- No Co-Authored-By needed
- Keep it short and clear

**Examples**:
```
feat(settings): add image max tokens slider for VLMs
feat(model): pass image_max_tokens to initMultimodal
chore(types): add image_max_tokens to ContextInitParams
```

### Naming Conventions
- Components: PascalCase (`SettingsScreen.tsx`)
- Stores: PascalCase with Store suffix (`ModelStore.ts`)
- Utils: camelCase (`contextInitParamsVersions.ts`)

---

## Reference Code

### Pattern Example: Context Parameter Versioning
**File**: `src/utils/contextInitParamsVersions.ts`
**Lines**: 105-164
```typescript
// Migration from 1.0 to 2.0: no_gpu_devices → devices, flash_attn → flash_attn_type
if (migratedParams.version === '1.0') {
  // Migrate no_gpu_devices to devices
  if ('no_gpu_devices' in migratedParams) {
    if (migratedParams.no_gpu_devices === true) {
      migratedParams.n_gpu_layers = 0;
      migratedParams.devices = undefined;
    } else {
      migratedParams.devices = undefined;
      if (
        migratedParams.n_gpu_layers === undefined ||
        migratedParams.n_gpu_layers === 0
      ) {
        migratedParams.n_gpu_layers = 99;
      }
    }
  }

  // Add new required parameters with defaults
  if (migratedParams.kv_unified === undefined) {
    migratedParams.kv_unified = true;
  }

  if (migratedParams.n_parallel === undefined) {
    migratedParams.n_parallel = 1;
  }

  migratedParams.version = '2.0';
}
```

### Pattern Example: InputSlider in Settings
**File**: `src/screens/SettingsScreen/SettingsScreen.tsx`
**Lines**: 530-554
```typescript
{/* Thread Count Slider */}
<View style={styles.settingItemContainer}>
  <InputSlider
    testID="thread-count-slider"
    label={l10n.settings.cpuThreads}
    value={modelStore.contextInitParams.n_threads}
    onValueChange={value =>
      modelStore.setNThreads(Math.round(value))
    }
    min={1}
    max={modelStore.max_threads}
    step={1}
  />
  <Text variant="labelSmall" style={styles.textDescription}>
    {l10n.settings.cpuThreadsDescription
      .replace(
        '{{threads}}',
        modelStore.contextInitParams.n_threads.toString(),
      )
      .replace(
        '{{maxThreads}}',
        modelStore.max_threads.toString(),
      )}
  </Text>
</View>
<Divider />
```

### Pattern Example: ModelStore Setter
**File**: `src/store/ModelStore.ts`
**Lines**: ~300-350 (approximate, search for setNThreads)
```typescript
setNThreads = (threads: number) => {
  this.contextInitParams.n_threads = threads;
};
```

---

## Dependencies

### Blocked By
- None

### Blocks
- None

---

## Risks & Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Default too low, VLM quality degraded | Low | Medium | Use 512 (conservative for device performance), user can adjust up to 4096 |
| Migration breaks existing params | Low | High | Test migration thoroughly, follow existing v1→v2 pattern |
| UI clutter in Advanced Settings | Low | Low | Keep in collapsed section, follows existing pattern |
| llama.rn API mismatch | Low | Medium | Parameter already available in llama.rn PR #275 |

---

## Open Questions

### For Human
- None (all decisions made based on Linear ticket and llama.rn PR #275)

### Resolved
- Q: What should the default be?
  - A: 512 tokens (lower than llama.cpp default of 2048, device-appropriate)
- Q: Should this be in Advanced Settings?
  - A: Yes, follows existing pattern for technical parameters
- Q: What range should the slider have?
  - A: 256-4096, step 1 (covers typical use cases)

---

## Agent Reports

### Planner Report
```
Story created for TASK-20260205-0807: Implement image max tokens setting for VLMs

Research Summary:
- Reviewed ContextInitParams versioning system (currently v2.0)
- Studied existing parameter migration patterns (v1.0→v2.0)
- Analyzed ModelStore.initMultimodal() call site
- Examined SettingsScreen InputSlider patterns (n_batch, n_ubatch, n_threads)
- Verified llama.rn API supports image_max_tokens parameter
- Checked localization structure (EN, JA, ZH)

Key Findings:
- Parameter already exists in llama.rn (PR #275), just needs exposure
- Follows established versioning pattern (2.0→2.1)
- UI pattern well-established with other sliders
- No native changes required (TypeScript/UI only)

Implementation Approach:
1. Type definition update (ContextInitParams)
2. Versioning and migration (2.0→2.1)
3. ModelStore setter and initMultimodal call
4. UI InputSlider in Advanced Settings
5. Localization for 3 languages
6. Mock and test updates

Estimated Complexity: Standard (6 files modified, clear patterns to follow)
```

### Implementation Report
```
Implementation completed successfully for TASK-20260205-0807: Implement image max tokens setting for VLMs

Environment:
- Task ID: TASK-20260205-0807
- Worktree: /Users/aghorbani/codes/pocketpal-dev-team/worktrees/TASK-20260205-0807
- Branch: feature/TASK-20260205-0807

Story:
TASK-20260205-0807: Implement image max tokens setting for VLMs

Status: complete

Changes Made:

| File | Change | Commit |
|------|--------|--------|
| src/utils/types.ts | Added image_max_tokens to ContextInitParams | 7fdfb5d |
| src/utils/contextInitParamsVersions.ts | Version 2.0→2.1, migration, default 512 | 2717bbc |
| src/utils/__tests__/benchmarkMigration.test.ts | Updated tests for v2.1 | 2717bbc |
| src/store/ModelStore.ts | Added setImageMaxTokens, pass to initMultimodal | 72647e9 |
| src/screens/SettingsScreen/SettingsScreen.tsx | Added InputSlider in Advanced Settings | 6474fdc |
| src/utils/l10n.ts | Added EN/JA/ZH localization strings | 6474fdc |
| __mocks__/external/llama.rn.ts | Added initMultimodal mock | 305dc83 |

Deviations from Plan:
None. All steps followed exactly as specified in the story file.

Verification Results:
- Lint: PASS (only pre-existing warnings in unrelated files)
- TypeCheck: PASS
- Related Tests: PASS (all tests passing, 1180 passed)
- Pod Install: N/A (NATIVE_CHANGES=NO)
- iOS Build: N/A (NATIVE_CHANGES=NO)
- Android Build: N/A (NATIVE_CHANGES=NO)

Notes for Tester:
- Focus on SettingsScreen slider rendering and interaction
- Test ModelStore.setImageMaxTokens method
- Verify migration from v2.0 to v2.1 adds default value
- Check that slider value changes call the correct store method
- Verify localization strings display correctly

Blockers: None
```

### Test Report
```
Test implementation completed successfully for TASK-20260205-0807: Implement image max tokens setting for VLMs

Environment:
- Task ID: TASK-20260205-0807
- Worktree: /Users/aghorbani/codes/pocketpal-dev-team/worktrees/TASK-20260205-0807
- Branch: feature/TASK-20260205-0807

Story:
TASK-20260205-0807: Implement image max tokens setting for VLMs

Status: complete

Tests Written:

| File | Tests Added | Type |
|------|-------------|------|
| src/utils/__tests__/contextInitParamsVersions.test.ts | 3 | Migration & defaults |
| src/store/__tests__/ModelStore.test.ts | 1 | Store setter |
| src/screens/SettingsScreen/__tests__/SettingsScreen.test.tsx | 2 | UI rendering & interaction |
| __mocks__/stores/modelStore.ts | - | Mock updates (setImageMaxTokens, setNThreads, setNBatch, setNUBatch) |

Test Coverage:

1. ✅ Migration from v2.0 to v2.1 adds default value (512)
2. ✅ Migration preserves existing image_max_tokens value
3. ✅ createDefaultContextInitParams includes image_max_tokens (512)
4. ✅ ModelStore.setImageMaxTokens updates contextInitParams.image_max_tokens
5. ✅ SettingsScreen renders image-max-tokens-slider in Advanced Settings
6. ✅ SettingsScreen calls setImageMaxTokens on slider value change

Test Results:
- Total Test Suites: 121 passed, 121 total
- Total Tests: 1416 passed, 14 skipped, 1430 total
- New Tests: 6 tests added, all passing
- Coverage: Meets 60% threshold (global requirement)

Specific Test Run (Modified Files):
- contextInitParamsVersions.test.ts: 12 passed (3 new)
- ModelStore.test.ts: 113 passed (1 new)
- SettingsScreen.test.tsx: 11 passed (2 new)

Test Details:

1. contextInitParamsVersions.test.ts:
   - "should migrate from v2.0 to v2.1 with default image_max_tokens" - Verifies v2.0 params without image_max_tokens get default 512
   - "should preserve existing image_max_tokens when migrating from v2.0 to v2.1" - Verifies custom values are preserved
   - "should include image_max_tokens with default value" - Verifies createDefaultContextInitParams includes 512

2. ModelStore.test.ts:
   - "should set image_max_tokens" - Verifies setImageMaxTokens(768) updates contextInitParams.image_max_tokens to 768

3. SettingsScreen.test.tsx:
   - "renders image max tokens slider in advanced settings" - Verifies slider appears when Advanced Settings expanded
   - "updates image max tokens correctly" - Verifies onValueChange calls modelStore.setImageMaxTokens with correct value

Notes:
- All tests follow PocketPal testing patterns (jest/test-utils, runInAction, no inline mocks)
- Mock store updated with necessary methods (setImageMaxTokens, setNThreads, setNBatch, setNUBatch)
- Tests use fake timers for debounced interactions (300ms debounce on slider)
- Tests validate both migration and UI functionality
- No regressions in existing test suite (all 1410 existing tests still pass)

Blockers: None
```

### Review Report
```
[Filled by reviewer after review]
```

---

## Changelog

| Date | Agent/Human | Change |
|------|-------------|--------|
| 2026-02-05 | orchestrator | Created worktree and classified as standard complexity |
| 2026-02-05 | planner | Created comprehensive implementation story |
| 2026-02-05 | human | Approved with default value changed to 512 |
| 2026-02-05 | implementer | Implementation complete |
| 2026-02-05 | tester | Tests written (6 new tests) |
| 2026-02-05 | reviewer | Review passed, PR #557 created |
| 2026-02-05 | human | Iteration 1 requested: cap to context size |
| 2026-02-05 | human | Iteration 1 revised: use effective value pattern + keyboard dismiss fix |

---

## Iteration 1: Effective Value Display + Keyboard Dismiss Fix

### Status
`[ ] Implementing → [ ] Testing → [ ] Reviewing`

### Requirements

**1. Show effective value (consistent with n_batch pattern)**
Instead of capping the slider max, allow users to set any value up to 4096 but show the effective value when it exceeds context size. This matches the existing pattern for `n_batch` and `n_ubatch` sliders.

**2. Fix keyboard dismiss on tap outside**
When tapping outside a text input in the settings screen, the keyboard should dismiss and the input should unfocus. This provides better UX by:
- Propagating changes if they impact other settings
- Giving users feedback that changes are auto-applied (no save button needed)

### Rationale
- **Consistency**: Users expect same behavior across all settings sliders
- **Transparency**: Showing "(effective: X)" explains why a higher value doesn't work
- **UX**: Tapping outside should dismiss keyboard (standard mobile pattern)

### Implementation Steps

#### Step 7: Show Effective Value in Description (n_batch pattern)
**Files**: `src/screens/SettingsScreen/SettingsScreen.tsx`, `src/utils/l10n.ts`
**Status**: `DONE` (commit cda93b1)

**Changes**:
- [x] Keep slider max at 4096 (no capping)
- [x] Update description to show "(effective: X)" when image_max_tokens > n_ctx
- [x] Follow exact pattern from n_batch slider (lines 477-490)

**Pattern Reference** (n_batch at lines 477-490):
```tsx
<Text variant="labelSmall" style={styles.textDescription}>
  {l10n.settings.batchSizeDescription
    .replace(
      '{{batchSize}}',
      modelStore.contextInitParams.n_batch.toString(),
    )
    .replace(
      '{{effectiveBatch}}',
      modelStore.contextInitParams.n_batch >
        modelStore.contextInitParams.n_ctx
        ? ` (${l10n.settings.effectiveLabel}: ${modelStore.contextInitParams.n_ctx})`
        : '',
    )}
</Text>
```

**Code Guidance for image_max_tokens**:
```tsx
<Text variant="labelSmall" style={styles.textDescription}>
  {l10n.settings.imageMaxTokensDescription
    .replace(
      '{{tokens}}',
      (modelStore.contextInitParams.image_max_tokens ?? 512).toString(),
    )
    .replace(
      '{{effectiveTokens}}',
      (modelStore.contextInitParams.image_max_tokens ?? 512) >
        modelStore.contextInitParams.n_ctx
        ? ` (${l10n.settings.effectiveLabel}: ${modelStore.contextInitParams.n_ctx})`
        : '',
    )}
</Text>
```

**Localization Updates**:
```typescript
// EN - update existing description
imageMaxTokensDescription:
  'Maximum tokens for image processing: {{tokens}}{{effectiveTokens}} (lower = faster, less detail)',

// JA - update existing description
imageMaxTokensDescription:
  '画像処理の最大トークン数: {{tokens}}{{effectiveTokens}} (低い = 高速、詳細度低)',

// ZH - update existing description
imageMaxTokensDescription:
  '图像处理的最大令牌数: {{tokens}}{{effectiveTokens}} (较低 = 更快，细节较少)',
```

Note: `effectiveLabel` already exists in l10n (used by n_batch): "effective" / "有効" / "有效"

#### Step 8: Apply Effective Value in getEffectiveContextInitParams
**Files**: `src/store/ModelStore.ts`
**Status**: `DONE` (commit 47eb5bc)

**Changes**:
- [x] Keep setter simple (no clamping) - just set the value
- [x] Pass effective (clamped) value to `initMultimodal()` using Math.min(image_max_tokens, n_ctx)

**Code Guidance**:
```typescript
// In getEffectiveContextInitParams() - add after effectiveUBatch calculation:
const effectiveImageMaxTokens = Math.min(
  this.contextInitParams.image_max_tokens ?? 512,
  effectiveContext,  // Can't exceed context size
);

// The effective value should be used when initializing multimodal
```

**Update initMultimodal call** (around line 1432):
```typescript
const success = await ctx.initMultimodal({
  path: mmProjPath,
  use_gpu: !this.contextInitParams.no_gpu_devices,
  image_max_tokens: Math.min(
    this.contextInitParams.image_max_tokens ?? 512,
    this.contextInitParams.n_ctx,
  ),
});
```

#### Step 9: Fix Keyboard Dismiss on Tap Outside
**Files**: `src/screens/SettingsScreen/SettingsScreen.tsx`
**Status**: `DONE` (commit c827720)

**Issue**: The existing `TouchableWithoutFeedback` with `handleOutsidePress` doesn't properly dismiss keyboard when tapping on certain areas (may be intercepted by ScrollView or other components).

**Changes**:
- [x] Added `keyboardShouldPersistTaps="handled"` to ScrollView
- [x] This allows taps to be handled properly and keyboard to dismiss when tapping outside inputs

**Code Guidance**:
```tsx
<ScrollView
  contentContainerStyle={styles.container}
  keyboardShouldPersistTaps="handled"  // Allow taps to dismiss keyboard
>
```

If the issue persists, wrap the content differently or add `Pressable` with `onPress={Keyboard.dismiss}` to empty areas.

### Test Requirements (Iteration 1)

| Test Case | File | Priority |
|-----------|------|----------|
| Description shows effective value when image_max_tokens > n_ctx | `SettingsScreen.test.tsx` | MUST |
| initMultimodal receives clamped value | `ModelStore.test.ts` | MUST |
| Keyboard dismisses when tapping outside text input | `SettingsScreen.test.tsx` | MUST |

### Acceptance Criteria (Iteration 1)

- [ ] Slider max stays at 4096 (no capping)
- [ ] Description shows "(effective: X)" when value > n_ctx
- [ ] Follows exact pattern of n_batch/n_ubatch effective display
- [ ] initMultimodal receives clamped value (min of user value and n_ctx)
- [ ] Keyboard dismisses when tapping outside text inputs
- [ ] Localization updated for EN, JA, ZH
- [ ] Tests cover effective value display and keyboard dismiss
