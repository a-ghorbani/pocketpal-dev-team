# Story: Upgrade llama.rn to 0.11.0-rc.2

## Metadata
- **Task ID**: TASK-20260122-1631
- **Issue**: N/A (dependency upgrade)
- **Source**: prompt
- **Complexity**: standard
- **Native Changes**: YES
- **Created**: 2026-01-22T16:31:00Z
- **Status**: draft

## Environment
- **Worktree**: `/Users/aghorbani/codes/pocketpal-dev-team/worktrees/TASK-20260122-1631`
- **Branch**: `feature/TASK-20260122-1631`
- **Base**: `main`

---

## Progress Tracking

### Current Phase
`[x] Planning → [ ] Approved → [ ] Implementing → [ ] Testing → [ ] Reviewing → [ ] PR Created`

### Checkpoints (Updated by Agents)

| Checkpoint | Status | Agent | Commit | Notes |
|------------|--------|-------|--------|-------|
| Worktree created | DONE | orchestrator | - | |
| Story approved | PENDING | human | - | |
| Step 1: Upgrade package.json | PENDING | implementer | - | |
| Step 2: iOS pod install | PENDING | implementer | - | |
| Step 3: Verify builds | PENDING | implementer | - | |
| Tests run | PENDING | implementer | - | |
| Review passed | PENDING | reviewer | - | |
| PR created | PENDING | reviewer | - | |

### Last Agent Handoff
```yaml
from_agent: planner
to_agent: human
timestamp: 2026-01-22T16:31:00Z
status: "Story created, awaiting approval"
completed:
  - Analyzed current llama.rn usage (0.11.0-rc.0)
  - Identified all files importing from llama.rn (16 imports)
  - Verified testing infrastructure (Jest mocks in place)
  - Confirmed native build requirements (iOS Podfile, Android gradle)
next_steps:
  - Human review and approve story
  - Implementer upgrades package.json
  - Run pod install and commit Podfile.lock
  - Run platform builds to verify
blockers: []
context_for_next_agent: |
  This is a native dependency upgrade requiring:
  - NATIVE_CHANGES=YES - pod install + iOS/Android builds required
  - No breaking API changes expected based on version increment
  - llama.rn is mocked in Jest (__mocks__/external/llama.rn.ts)
  - Current version: 0.11.0-rc.0
  - Target version: 0.11.0-rc.2
  - Changes: async teardown stabilization, Jest mock updates, TaskManager timeout additions, llama.cpp sync to b7798
```

---

## Context (For Recovery After Context Reset)

> **If you're an agent resuming work on this story:**
> 1. Read the "Progress Tracking" section above
> 2. Check `git log` in the worktree for commits
> 3. Read the "Last Agent Handoff" section
> 4. Continue from the next incomplete checkpoint

### Background

llama.rn is the core native library powering PocketPal's on-device LLM inference. It's a React Native binding for llama.cpp, providing the native bridge that allows PocketPal to run language models directly on iOS and Android devices.

The library is currently at version 0.11.0-rc.0 and needs to be upgraded to 0.11.0-rc.2, which includes:
- Async teardown stabilization
- Jest mock updates
- TaskManager timeout additions
- llama.cpp sync to b7798

This is a minor RC version bump with no reported breaking API changes.

### Current State

**Package Version**: `llama.rn: 0.11.0-rc.0` (line 50 in package.json)

**Current Usage in Codebase**:
- Primary integration: `src/store/ModelStore.ts` - Main store managing model lifecycle
- Imports from llama.rn across 16 files:
  - `LlamaContext` - 9 files (ModelStore, tests, utils)
  - `initLlama` - 1 file (ModelStore.ts)
  - `ContextParams` - 4 files (types, utils, components)
  - `CompletionParams` - 1 file (completionTypes.ts)
  - `BuildInfo` - 1 file (AboutScreen.tsx)
  - `loadLlamaModelInfo` - 2 files (memorySettings.ts, tests)
  - `getBackendDevicesInfo` - 1 file (deviceSelection.ts)
  - `JinjaFormattedChatResult` - 2 files (chat.ts, TestCompletionScreen)
  - `TokenData` - 1 file (types.ts)

**Testing Infrastructure**:
- Jest mock: `__mocks__/external/llama.rn.ts` provides `MockLlamaContext` class
- Mock mapped in `jest.config.js` line 37: `'llama.rn': '<rootDir>/__mocks__/external/llama.rn.ts'`
- All tests using llama.rn work with the mock, not the real library

**Native Build Configuration**:
- iOS: Podfile has special handling for llama-rn (lines 62-72) to force static library build type
- iOS: Current Podfile.lock shows `llama-rn (0.11.0-rc.0)` at line 61
- Android: gradle.properties has commented option for building from source (line 42)
- Android: Uses prebuilt binaries by default

### Target State

- Package version upgraded to `llama.rn: 0.11.0-rc.2`
- iOS Podfile.lock updated with new version and any dependency changes
- iOS Release build succeeds
- Android Release build succeeds
- All existing tests continue to pass
- No code changes required (no breaking API changes)

---

## Requirements

### Functional
1. [MUST] Upgrade llama.rn from 0.11.0-rc.0 to 0.11.0-rc.2 in package.json
2. [MUST] Run `pod install` to update iOS dependencies
3. [MUST] Commit updated Podfile.lock
4. [MUST] Verify iOS Release build succeeds
5. [MUST] Verify Android Release build succeeds

### Non-Functional
- Performance: No degradation expected (native library optimizations may improve performance)
- Compatibility: Must work on existing iOS 16+ and Android 11+ targets
- Security: Continue to support on-device inference with no data leaving device

### Platform Verification (NATIVE_CHANGES=YES)
- [ ] `cd ios && pod install && cd ..` succeeds
- [ ] iOS Release build succeeds: `yarn ios --configuration Release`
- [ ] Android Release build succeeds: `yarn android --variant=release`
- [ ] `ios/Podfile.lock` changes committed
- [ ] All existing tests pass

---

## Acceptance Criteria

- [ ] package.json shows `llama.rn: 0.11.0-rc.2`
- [ ] Podfile.lock updated and committed
- [ ] iOS Release build completes without errors
- [ ] Android Release build completes without errors
- [ ] `yarn test` passes with 60%+ coverage
- [ ] `yarn typecheck` passes
- [ ] `yarn lint` passes
- [ ] No console warnings or errors related to llama.rn

---

## Affected Files

| File | Action | Reason | Status |
|------|--------|--------|--------|
| `package.json` | MODIFY | Update llama.rn version from 0.11.0-rc.0 to 0.11.0-rc.2 | PENDING |
| `ios/Podfile.lock` | MODIFY | Auto-generated by pod install, must be committed | PENDING |
| `yarn.lock` | MODIFY | Auto-generated by yarn install | PENDING |

**Note**: No source code changes required. All TypeScript imports remain compatible.

---

## Implementation Plan

### Step 1: Upgrade Package Version
**Files**: `package.json`
**Status**: `PENDING`
**Commit**: [commit hash when done]

**Change**:
- [ ] Update line 50: `"llama.rn": "0.11.0-rc.2"`
- [ ] Run `yarn install` to update yarn.lock
- [ ] Verify no peer dependency warnings

**Verification**:
```bash
cd "${WORKTREE_PATH}"
grep "llama.rn" package.json
yarn install
yarn typecheck
```

### Step 2: Update iOS Dependencies
**Files**: `ios/Podfile.lock`
**Status**: `PENDING`
**Commit**: [commit hash when done]

**Change**:
- [ ] Run `cd ios && pod install && cd ..`
- [ ] Verify Podfile.lock shows `llama-rn (0.11.0-rc.2)`
- [ ] Check for any new transitive dependencies
- [ ] Commit Podfile.lock changes

**Verification**:
```bash
cd "${WORKTREE_PATH}"
cd ios && pod install && cd ..
grep "llama-rn" ios/Podfile.lock | head -1
git diff ios/Podfile.lock
```

### Step 3: Platform Build Verification
**Status**: `PENDING`
**Commit**: [commit hash when done]

**Change**:
- [ ] Run iOS Release build: `yarn ios --configuration Release`
- [ ] Wait for build to complete (may take 5-10 minutes)
- [ ] Verify app launches on simulator
- [ ] Run Android Release build: `yarn android --variant=release`
- [ ] Wait for build to complete
- [ ] Verify app launches on emulator or device

**Verification**:
```bash
cd "${WORKTREE_PATH}"

# iOS build
yarn ios --configuration Release

# Android build
yarn android --variant=release
```

**Expected Outcome**:
- No build errors
- No linker errors
- App launches successfully
- No runtime crashes on initialization

### Step 4: Run Test Suite
**Status**: `PENDING`
**Commit**: N/A (no code changes)

**Change**:
- [ ] Run `yarn test` to verify all tests pass
- [ ] Check coverage meets 60% threshold
- [ ] Verify no new warnings or errors

**Verification**:
```bash
cd "${WORKTREE_PATH}"
yarn test
yarn lint
yarn typecheck
```

**Expected Outcome**:
- All tests pass
- Coverage >= 60%
- No linter errors
- No TypeScript errors

---

## Test Requirements

### Unit Tests
| Test Case | File | Priority | Status |
|-----------|------|----------|--------|
| Verify mock still works | `ModelStore.test.ts` | MUST | PENDING |
| Verify LlamaContext mock | `ChatScreen.test.tsx` | MUST | PENDING |
| All existing tests pass | All test files | MUST | PENDING |

**Note**: No new tests required - this is a drop-in replacement upgrade. The Jest mock (`__mocks__/external/llama.rn.ts`) abstracts the real library, so tests should pass without modification.

### Integration Tests
| Test Case | File | Priority | Status |
|-----------|------|----------|--------|
| App launches successfully | Manual | MUST | PENDING |
| Model loading works | Manual | MUST | PENDING |
| Inference completes | Manual | SHOULD | PENDING |

### Manual Testing
- [ ] Launch app on iOS simulator (Release build)
- [ ] Launch app on Android emulator (Release build)
- [ ] Navigate to Models screen
- [ ] Attempt to load a model (if one is downloaded)
- [ ] Verify no crashes or errors in console

---

## Coding Standards

### Testing Infrastructure (CRITICAL)
```
# The existing Jest mock will handle this upgrade:
${WORKTREE_PATH}/__mocks__/external/llama.rn.ts

# No changes needed to the mock unless new APIs are introduced
# All tests import from 'llama.rn' which is mapped to the mock
```

### Patterns to Follow
- **Dependencies**: Native dependency upgrades require pod install + builds
- **Version Control**: Always commit Podfile.lock and yarn.lock changes
- **Verification**: Always run Release builds, not Debug builds, for native changes

### Commit Format (enforced by commitlint)
```
chore(deps): upgrade llama.rn to 0.11.0-rc.2
```

**Rules**:
- Type: `chore` (dependency upgrade)
- Scope: `deps`
- Keep header under 100 chars
- Reference changes in body if needed

**Example**:
```
chore(deps): upgrade llama.rn to 0.11.0-rc.2

Includes:
- Async teardown stabilization
- Jest mock updates
- TaskManager timeout additions
- llama.cpp sync to b7798

Verified builds: iOS Release, Android Release
```

---

## Reference Code

### Pattern Example: Current llama.rn Usage
**File**: `src/store/ModelStore.ts`
**Lines**: 8-9
```typescript
import {ContextParams, LlamaContext, initLlama} from 'llama.rn';
```

This import pattern should continue to work without modification. No breaking changes in the API.

### Pattern Example: Jest Mock
**File**: `__mocks__/external/llama.rn.ts`
**Lines**: 1-54
```typescript
class MockLlamaContext {
  id: number;
  contextId: number;
  gpu: boolean;
  reasonNoGPU: string;
  systemInfo: string;
  model: {isChatTemplateSupported?: boolean};

  constructor({
    contextId,
    gpu = false,
    reasonNoGPU = '',
    systemInfo = '',
    model = {},
  }: {
    contextId: number;
    gpu?: boolean;
    reasonNoGPU?: string;
    systemInfo?: string;
    model?: {isChatTemplateSupported?: boolean};
  }) {
    this.id = contextId;
    this.contextId = contextId;
    this.gpu = gpu;
    this.reasonNoGPU = reasonNoGPU;
    this.systemInfo = systemInfo;
    this.model = model;
  }

  loadSession = jest.fn();
  saveSession = jest.fn();
  completion = jest.fn();
  stopCompletion = jest.fn();
  bench = jest.fn();
}
```

This mock may need updates if llama.rn 0.11.0-rc.2 introduces new methods or properties. However, based on the RC version increment, this is unlikely.

### Pattern Example: Podfile llama-rn Configuration
**File**: `ios/Podfile`
**Lines**: 61-72
```ruby
  # Force llama-rn to build as static library to avoid duplicate headers
  pre_install do |installer|
    installer.pod_targets.each do |pod|
      # Fix "Multiple commands produce" for llama-rn
      if pod.name == 'llama-rn' || pod.name.start_with?('llama')
        puts "Forcing #{pod.name} to static_library build type"
        def pod.build_type
          Pod::BuildType.static_library
        end
      end
    end
  end
```

This configuration should remain unchanged. The Podfile itself does not need modification.

---

## Dependencies

### Blocked By
- None

### Blocks
- None

---

## Risks & Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Build failures on iOS due to native code changes | Low | High | Run `pod install` and full Release build before committing |
| Build failures on Android due to NDK incompatibility | Low | High | Run Android Release build to verify |
| New API breaking changes not documented in RC | Low | Medium | Run full test suite; check for TypeScript errors |
| Podfile.lock merge conflicts if main is updated | Medium | Low | Rebase on main before creating PR |
| Mock becomes outdated if new methods added | Low | Medium | Check test failures; update mock if needed |
| Performance regression in inference | Low | Medium | Monitor for user reports; version is RC so regressions possible |

---

## Open Questions

### For Human
- None

### Resolved
- **Q**: Are there breaking changes in 0.11.0-rc.2?
  - **A**: No breaking API changes expected based on orchestrator context and RC version increment
- **Q**: Do we need to update the Jest mock?
  - **A**: Not unless new APIs are introduced. Will verify during testing phase.
- **Q**: Should we test on real devices?
  - **A**: Not required for this story - simulator/emulator verification is sufficient. Real device testing will occur during QA.

---

## Agent Reports

### Planner Report
```
Story Creation Report - TASK-20260122-1631

Research Completed:
- Identified current version: 0.11.0-rc.0 (package.json line 50)
- Mapped all imports: 16 files importing from llama.rn
- Verified Jest mock exists: __mocks__/external/llama.rn.ts
- Confirmed iOS Podfile configuration (static library build)
- Confirmed Android gradle configuration (prebuilt binaries)
- Reviewed Podfile.lock current state: llama-rn (0.11.0-rc.0)

Key Findings:
- No source code changes required (no breaking API changes)
- Native build verification is CRITICAL (NATIVE_CHANGES=YES)
- Jest mock should handle upgrade transparently
- iOS Podfile has special pre_install hook for llama-rn
- All tests use the mock, not real library

Story Type: Standard (native dependency upgrade)
Complexity: Medium (requires platform builds)
Risk Level: Low-Medium (RC version, well-tested library)

Next Steps:
1. Human approval of story
2. Implementer upgrades package.json
3. Implementer runs pod install
4. Implementer runs iOS + Android Release builds
5. Reviewer verifies builds and creates PR

Estimated Effort: 30-60 minutes (mostly build time)
```

### Implementation Report
```
[Filled by implementer after code complete]
```

### Test Report
```
[Filled by tester after tests written - N/A for this story as no new tests needed]
```

### Review Report
```
[Filled by reviewer after review]
```

---

## Changelog

| Date | Agent/Human | Change |
|------|-------------|--------|
| 2026-01-22 | orchestrator | Created worktree and task |
| 2026-01-22 | planner | Initial story draft created |

---

## Additional Notes

### llama.rn Upgrade Context (from orchestrator)

```
Context from orchestrator:
- Upgrading from 0.11.0-rc.0 to 0.11.0-rc.2
- Changes include: async teardown stabilization, Jest mock updates, TaskManager timeout additions, llama.cpp sync to b7798
- No breaking API changes expected
```

### Important Files to Monitor

1. **package.json** - Version number
2. **ios/Podfile.lock** - iOS dependency resolution
3. **yarn.lock** - JavaScript dependency resolution
4. **Build outputs** - Watch for errors during Release builds

### Platform-Specific Notes

**iOS**:
- Uses static library build type (configured in Podfile)
- Build time: ~5-10 minutes for Release
- Simulator: iPhone 16 Pro (default from package.json script)

**Android**:
- Uses prebuilt binaries (not building from source)
- Build time: ~5-10 minutes for Release
- Architectures: arm64-v8a, x86_64 (from gradle.properties)

### Post-Upgrade Verification

After upgrade is complete and PR is merged, monitor for:
- User reports of crashes or issues
- Performance changes (could be positive)
- Memory usage changes
- Build time changes in CI

### Rollback Plan

If critical issues are found:
1. Revert the version in package.json to 0.11.0-rc.0
2. Run `yarn install`
3. Run `cd ios && pod install && cd ..`
4. Rebuild both platforms

No data migration or user data is affected by this change.
