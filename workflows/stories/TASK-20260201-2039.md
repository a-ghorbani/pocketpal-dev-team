# Story: Upgrade llama.rn to 0.11.0-rc.3

## Metadata
- **Task ID**: TASK-20260201-2039
- **Issue**: N/A (Dependency upgrade)
- **Source**: prompt
- **Complexity**: standard
- **Native Changes**: YES
- **Created**: 2026-02-01T20:40:00Z
- **Status**: draft

## Environment
- **Worktree**: `/Users/aghorbani/codes/pocketpal-dev-team/worktrees/TASK-20260201-2039`
- **Branch**: `feature/TASK-20260201-2039`
- **Base**: `main`

---

## Progress Tracking

### Current Phase
`[✓] Planning → [✓] Approved → [✓] Implementing → [ ] Testing → [ ] Reviewing → [ ] PR Created`

### Checkpoints (Updated by Agents)

| Checkpoint | Status | Agent | Commit | Notes |
|------------|--------|-------|--------|-------|
| Worktree created | DONE | orchestrator | - | |
| Story approved | DONE | human | - | |
| Step 1 complete | DONE | implementer | 726ff45 | Update package.json |
| Step 2 complete | DONE | implementer | 726ff45 | Update yarn.lock |
| Step 3 complete | DONE | implementer | 726ff45 | iOS pod install |
| Step 4 complete | DONE | implementer | 726ff45 | Platform builds |
| Tests verified | DONE | implementer | 726ff45 | All tests passed (1364 passed, 2 skipped) |
| Review passed | PENDING | reviewer | - | |
| PR created | PENDING | reviewer | - | |

### Last Agent Handoff
```yaml
from_agent: implementer
to_agent: reviewer
timestamp: 2026-02-01T21:02:00Z
status: "Implementation complete, ready for review"
completed:
  - Updated package.json llama.rn version from 0.11.0-rc.2 to 0.11.0-rc.3
  - Ran yarn install and updated yarn.lock
  - Ran pod install and updated ios/Podfile.lock
  - All tests passed (1364 passed, 2 skipped)
  - Lint passed (3 pre-existing warnings, no errors)
  - TypeScript typecheck passed
  - iOS Release build succeeded
  - Android Release build succeeded
  - Committed all changes (commit 726ff45)
next_steps:
  - Run final quality checks
  - Verify builds one more time
  - Create draft PR
blockers: []
context_for_next_agent: |
  NATIVE_CHANGES=YES - All platform builds verified successfully.
  No code changes were required - just dependency version bump and lock file updates.
  Both iOS (iPhone 17 Pro simulator) and Android builds completed successfully.
  All 3 files committed: package.json, yarn.lock, ios/Podfile.lock
```

---

## Context (For Recovery After Context Reset)

> **If you're an agent resuming work on this story:**
> 1. Read the "Progress Tracking" section above
> 2. Check `git log` in the worktree for commits
> 3. Read the "Last Agent Handoff" section
> 4. Continue from the next incomplete checkpoint

### Background
llama.rn is the core React Native library that provides bindings to llama.cpp, enabling on-device LLM inference in PocketPal. Regular updates are necessary to:
- Benefit from llama.cpp upstream improvements
- Fix bugs in the native bindings
- Improve inference performance
- Support new model architectures

Version 0.11.0-rc.3 includes:
- Bug fix for parallel decoding callbacks
- llama.cpp sync to b7836
- No documented breaking changes

### Current State
- **File**: `package.json:50` - Current version: `"llama.rn": "0.11.0-rc.2"`
- **File**: `yarn.lock` - Contains dependency resolution for 0.11.0-rc.2
- **File**: `ios/Podfile.lock` - Contains iOS native dependency lock for 0.11.0-rc.2
- **Pattern**: Previous upgrades (commits f8669db, 8b12e09, 623ad08) followed simple pattern:
  1. Update package.json version
  2. Run `yarn install` to update yarn.lock
  3. Run `cd ios && pod install` to update Podfile.lock
  4. Verify iOS and Android builds
  5. No code changes required

### Target State
- **File**: `package.json:50` - Updated to: `"llama.rn": "0.11.0-rc.3"`
- **File**: `yarn.lock` - Updated to resolve 0.11.0-rc.3
- **File**: `ios/Podfile.lock` - Updated iOS native dependencies for 0.11.0-rc.3
- **Outcome**: All platform builds pass, no code changes needed

---

## Requirements

### Functional
1. [MUST] Upgrade llama.rn from 0.11.0-rc.2 to 0.11.0-rc.3
2. [MUST] Update yarn.lock with new dependency resolution
3. [MUST] Update ios/Podfile.lock with new iOS native dependencies
4. [MUST] Verify no code changes are required (API compatibility)
5. [MUST] Verify all existing tests pass

### Non-Functional
- **Performance**: Should maintain or improve inference performance
- **Compatibility**: Must work on iOS (13.4+) and Android (API 24+)
- **Security**: Use exact version (not range) to ensure reproducible builds

### Platform Verification (NATIVE_CHANGES=YES)
- [ ] `yarn install` succeeds
- [ ] `pod install` succeeds in ios/ directory
- [ ] iOS Release build succeeds
- [ ] Android Release build succeeds
- [ ] `ios/Podfile.lock` changes committed

---

## Acceptance Criteria

- [ ] package.json contains `"llama.rn": "0.11.0-rc.3"`
- [ ] yarn.lock updated with correct checksums and dependencies
- [ ] ios/Podfile.lock updated with correct pod versions
- [ ] All existing unit tests pass (`yarn test`)
- [ ] iOS Release build completes successfully
- [ ] Android Release build completes successfully
- [ ] No code changes required in src/
- [ ] Lint and typecheck pass

---

## Affected Files

| File | Action | Reason | Status |
|------|--------|--------|--------|
| `package.json` | MODIFY | Bump llama.rn version to 0.11.0-rc.3 | PENDING |
| `yarn.lock` | MODIFY | Auto-generated by yarn install | PENDING |
| `ios/Podfile.lock` | MODIFY | Auto-generated by pod install | PENDING |

---

## Implementation Plan

### Step 1: Update package.json
**Files**: `package.json`
**Status**: `PENDING`
**Commit**: [commit hash when done]

**Change**:
- [ ] Change line 50 from `"llama.rn": "0.11.0-rc.2"` to `"llama.rn": "0.11.0-rc.3"`

**Pattern Reference**: See commit f8669db (previous upgrade to 0.11.0-rc.2)

**Code Guidance**:
```json
{
  "dependencies": {
    // ... other deps
    "llama.rn": "0.11.0-rc.3",
    // ... other deps
  }
}
```

**Verification**:
```bash
cd "${WORKTREE_PATH}"
grep "llama.rn" package.json
# Should show: "llama.rn": "0.11.0-rc.3"
```

### Step 2: Update yarn.lock
**Files**: `yarn.lock`
**Status**: `PENDING`
**Commit**: [same commit as Step 1]

**Change**:
- [ ] Run `yarn install` to update yarn.lock automatically

**Verification**:
```bash
cd "${WORKTREE_PATH}"
yarn install
grep "llama.rn@0.11.0-rc.3" yarn.lock
# Should show resolved version
```

### Step 3: Update iOS Podfile.lock
**Files**: `ios/Podfile.lock`
**Status**: `PENDING`
**Commit**: [commit hash when done]

**Change**:
- [ ] Run `cd ios && pod install && cd ..`
- [ ] Verify Podfile.lock shows updated llama-rn version

**Pattern Reference**: See commit 3a9c51d (Podfile.lock update for rc.2)

**Verification**:
```bash
cd "${WORKTREE_PATH}"
cd ios && pod install && cd ..
grep "llama-rn" ios/Podfile.lock
# Should show: - llama-rn (0.11.0-rc.3):
```

### Step 4: Platform Verification (NATIVE_CHANGES=YES)
**Status**: `PENDING`
**Commit**: [verification complete, no commit]

**Change**:
- [ ] Run `yarn test` to verify all existing tests pass
- [ ] Run `yarn lint` and `yarn typecheck`
- [ ] Run `yarn ios --configuration Release` to verify iOS build
- [ ] Run `yarn android --variant=release` to verify Android build

**Verification**:
```bash
cd "${WORKTREE_PATH}"

# 1. Run tests
yarn test

# 2. Lint and typecheck
yarn lint
yarn typecheck

# 3. iOS Release build
yarn ios --configuration Release

# 4. Android Release build
yarn android --variant=release
```

### Step 5: Commit Changes
**Files**: `package.json`, `yarn.lock`, `ios/Podfile.lock`
**Status**: `PENDING`
**Commit**: [commit hash when done]

**Change**:
- [ ] Create commit with conventional commit format

**Pattern Reference**: See commit 8b12e09 message: `chore(deps): upgrade llama.rn to 0.11.0-rc.2`

**Commit Message**:
```
chore(deps): upgrade llama.rn to 0.11.0-rc.3
```

---

## Test Requirements

### Unit Tests
| Test Case | File | Priority | Status |
|-----------|------|----------|--------|
| Existing tests pass | All test files | MUST | PENDING |
| No new tests required | N/A | N/A | N/A |

**Rationale**: This is a dependency upgrade with no API changes. All existing tests that use llama.rn should continue to pass without modification.

### Integration Tests
| Test Case | File | Priority | Status |
|-----------|------|----------|--------|
| iOS build succeeds | ios/ | MUST | PENDING |
| Android build succeeds | android/ | MUST | PENDING |

### Manual Testing
- [ ] Install app on iOS device/simulator
- [ ] Load a model (verify llama.rn initialization)
- [ ] Send a message (verify inference works)
- [ ] Check for any console errors or crashes
- [ ] Install app on Android device/emulator
- [ ] Repeat model loading and inference tests

---

## Coding Standards

### Testing Infrastructure (CRITICAL)
```
# No test changes needed for this upgrade
# Existing mocks in __mocks__/external/llama.rn.ts should work as-is
# Verify tests pass: yarn test
```

### Patterns to Follow
- **Versioning**: Use exact version (no ^ or ~) for native dependencies
- **Lock files**: Commit both yarn.lock and ios/Podfile.lock
- **Build verification**: MUST verify both iOS and Android builds for native changes

### Commit Format (enforced by commitlint)
```
chore(deps): upgrade llama.rn to 0.11.0-rc.3
```

**Rules**:
- Type: `chore` (for dependency upgrades)
- Scope: `deps` (for dependency changes)
- Subject: Brief description of the upgrade
- No body needed for simple version bumps

---

## Reference Code

### Pattern Example: Previous llama.rn Upgrade
**Commit**: f8669db
**Files Changed**: package.json, yarn.lock, ios/Podfile.lock (3 files)
**Pattern**: Simple version bump, no code changes

**Commit**: 8b12e09
```
chore(deps): upgrade llama.rn to 0.11.0-rc.2

 package.json | 2 +-
 yarn.lock    | 8 ++++----
 2 files changed, 5 insertions(+), 5 deletions(-)
```

### Pattern Example: iOS Podfile.lock Update
**Commit**: 3a9c51d
```
chore(deps): update iOS Podfile.lock for llama.rn 0.11.0-rc.2
```

---

## Dependencies

### Blocked By
- None

### Blocks
- None

---

## Risks & Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Build failures on iOS/Android | Low | High | Verify builds before committing. Rollback if builds fail. |
| API breaking changes not documented | Low | Medium | Review git diff of llama.rn repo between rc.2 and rc.3 if issues arise. |
| Performance regression | Low | Medium | Run benchmark tests manually after upgrade. |
| OpenCL headers clone failure in postinstall | Low | Low | Postinstall script (scripts/postinstall.sh) handles this automatically. |

---

## Open Questions

### For Human
None - straightforward dependency upgrade following established pattern.

### Resolved
- [Q: Are there breaking changes?] -> [A: No, release notes indicate bug fix only]
- [Q: Do we need code changes?] -> [A: No, previous upgrades required no code changes]

---

## Agent Reports

### Planner Report
```
Research Summary:
- Analyzed codebase usage of llama.rn across 19 TypeScript files
- Reviewed previous upgrade commits (f8669db, 8b12e09, 623ad08, etc.)
- Confirmed pattern: version bump + lock files update + build verification
- No API changes detected in release notes
- No code changes anticipated

Affected Areas:
- Core inference: src/store/ModelStore.ts (imports LlamaContext, initLlama)
- Utils: src/utils/ (chat.ts, types.ts, memorySettings.ts, etc.)
- Testing: __mocks__/external/llama.rn.ts (mock stays compatible)

Risk Assessment: LOW
- Well-established upgrade pattern
- No breaking changes documented
- Previous rc upgrades (rc.0 -> rc.2) completed successfully
- Native builds are the primary risk, mitigated by verification step

Story Quality:
- All affected files identified (3 files)
- Clear step-by-step implementation plan
- Platform verification mandatory (NATIVE_CHANGES=YES)
- Commit message follows existing pattern
- No ambiguous requirements
```

### Implementation Report
```
Environment:
- Task ID: TASK-20260201-2039
- Worktree: /Users/aghorbani/codes/pocketpal-dev-team/worktrees/TASK-20260201-2039
- Branch: feature/TASK-20260201-2039
- Commit: 726ff45

Story: Upgrade llama.rn to 0.11.0-rc.3

Status: COMPLETE

Changes Made:
| File | Change | Commit |
|------|--------|--------|
| package.json | Updated llama.rn from 0.11.0-rc.2 to 0.11.0-rc.3 | 726ff45 |
| yarn.lock | Auto-updated by yarn install | 726ff45 |
| ios/Podfile.lock | Auto-updated by pod install | 726ff45 |

Deviations from Plan:
None. Implementation followed the plan exactly as specified.

Verification Results:
- Lint: PASS (3 pre-existing warnings, no errors)
- TypeCheck: PASS
- Unit Tests: PASS (1364 passed, 2 skipped)
- Bundle Install: PASS
- Pod Install: PASS
- iOS Build: PASS (Release build on iPhone 17 Pro simulator)
- Android Build: PASS (Release build via gradle assembleRelease)

Implementation Notes:
1. Updated package.json line 50 as specified
2. Ran yarn install successfully - yarn.lock updated
3. Ran bundle install && pod install in ios/ directory - Podfile.lock updated
4. All 1364 tests passed with 2 skipped (unchanged from baseline)
5. Lint passed with 3 pre-existing warnings (not related to this change)
6. TypeScript typecheck passed with no errors
7. iOS Release build succeeded (BUILD SUCCEEDED)
8. Android Release build succeeded (BUILD SUCCESSFUL in 3m 8s)
9. All changes committed in a single atomic commit

Notes for Reviewer:
- This is a straightforward dependency upgrade with no code changes
- All three lock files (yarn.lock and ios/Podfile.lock) updated as expected
- Both platform builds verified successfully
- No new warnings or errors introduced
- Ready for PR creation

Blockers: None
```

### Test Report
```
[Filled by tester after tests written]
```

### Review Report
```
[Filled by reviewer after review]
```

---

## Changelog

| Date | Agent/Human | Change |
|------|-------------|--------|
| 2026-02-01 | orchestrator | Created worktree and task |
| 2026-02-01 | planner | Initial story draft |
